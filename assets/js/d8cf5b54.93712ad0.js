"use strict";(self.webpackChunkcodiac=self.webpackChunkcodiac||[]).push([[7586],{5658:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>a,contentTitle:()=>o,default:()=>p,frontMatter:()=>n,metadata:()=>l,toc:()=>c});var i=r(4848),s=r(8453);const n={},o="Custom Filter Types",l={id:"api-base/basics/custom-filter-defs",title:"Custom Filter Types",description:"Say you want to add a criteria property that, when set, invokes complex filtering logic for a read operation in an entity repo.   A custom filter is a way to accomplish this.",source:"@site/docs/api-base/basics/custom-filter-defs.md",sourceDirName:"api-base/basics",slug:"/api-base/basics/custom-filter-defs",permalink:"/api-base/basics/custom-filter-defs",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/api-base/basics/custom-filter-defs.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Adding a Custom Endpoint",permalink:"/api-base/basics/custom-endpoints"},next:{title:"Custom Validation",permalink:"/api-base/basics/custom-validation"}},a={},c=[{value:"TL;DR",id:"tldr",level:2},{value:"The Scenario",id:"the-scenario",level:2},{value:"So Create a Custom Filter for Your Custom Logic",id:"so-create-a-custom-filter-for-your-custom-logic",level:3},{value:"How to Implement:",id:"how-to-implement",level:2},{value:"Step 1: Create Your Own Filter Class",id:"step-1-create-your-own-filter-class",level:3},{value:"Step 2: Create its FilterDefBuilder Class",id:"step-2-create-its-filterdefbuilder-class",level:3},{value:"Step 3: Register It with the Repo",id:"step-3-register-it-with-the-repo",level:3},{value:"Step 4: Use Custom Filter as a property type on a criteria class for your entity",id:"step-4-use-custom-filter-as-a-property-type-on-a-criteria-class-for-your-entity",level:3},{value:"Step 5:  Custom Deserializers",id:"step-5--custom-deserializers",level:3},{value:"Create your Deserializer",id:"create-your-deserializer",level:4},{value:"Register Your Deserializer With the Api",id:"register-your-deserializer-with-the-api",level:4}];function d(e){const t={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.h1,{id:"custom-filter-types",children:"Custom Filter Types"}),"\n",(0,i.jsx)(t.p,{children:"Say you want to add a criteria property that, when set, invokes complex filtering logic for a read operation in an entity repo.   A custom filter is a way to accomplish this."}),"\n",(0,i.jsx)(t.h2,{id:"tldr",children:"TL;DR"}),"\n",(0,i.jsx)(t.p,{children:"There are three steps to implementing a custom filter:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["Create your class implementing ",(0,i.jsx)(t.code,{children:"IFilter"}),"."]}),"\n",(0,i.jsxs)(t.li,{children:["Create its ",(0,i.jsx)(t.code,{children:"IFilterDefBuilder"})," Class"]}),"\n",(0,i.jsx)(t.li,{children:"Register it with the repo plugin."}),"\n",(0,i.jsx)(t.li,{children:"Use it in your criteria object as a property type or a property decorator."}),"\n",(0,i.jsxs)(t.li,{children:["(optional) Create a ",(0,i.jsx)(t.strong,{children:"custom deserializer"})," for it."]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"the-scenario",children:"The Scenario"}),"\n",(0,i.jsxs)(t.p,{children:["You're building a carnival api, and you want to add a criteria property to filter on the ",(0,i.jsx)(t.code,{children:"UserProfile"})," entities that are allowed to ride a given roller coaster.  Let's name this new property: ",(0,i.jsx)(t.code,{children:"canRide"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["Now if there were a boolean property named ",(0,i.jsx)(t.code,{children:"canRide"})," on your ",(0,i.jsx)(t.code,{children:"UserProfile"})," entity, then we'd be done; the repo would take it from there."]}),"\n",(0,i.jsxs)(t.p,{children:["But not in this scenario: there is no property ",(0,i.jsx)(t.code,{children:"canRide"})," on a user profile.  In fact, ",(0,i.jsx)(t.code,{children:"canRide"}),"  ",(0,i.jsx)(t.em,{children:"really means"}),"..."]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:'...is at least 42" tall'}),"\n",(0,i.jsx)(t.li,{children:"...AND is not a pregnant female"}),"\n",(0,i.jsx)(t.li,{children:"...AND does not have a heart condition"}),"\n",(0,i.jsx)(t.li,{children:"...AND is not overdue on membership fees"}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"So if our api receives a criteria object that looks like this:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-json",children:'{\n  "attraction": "greased-lightning",\n  "canRide": true\n}\n'})}),"\n",(0,i.jsxs)(t.p,{children:["...then the logic it needs to invoke is going to look something like this ",(0,i.jsx)(t.em,{children:"(using MongoDb)"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-json",children:'{\n  "height": { "$gt": 42 },\n  "$not": { \n    "sex": "female",\n    "pregnant": true\n  },\n  "medical": { \n    "$not": { \n      "$contains": "heart" \n    } \n  }\n}\n'})}),"\n",(0,i.jsx)(t.h3,{id:"so-create-a-custom-filter-for-your-custom-logic",children:"So Create a Custom Filter for Your Custom Logic"}),"\n",(0,i.jsxs)(t.p,{children:["A filter is a class type that you apply to a property on a criteria object.  Let's make a ",(0,i.jsx)(t.code,{children:"FastRollerCoasterFilter"})]}),"\n",(0,i.jsx)(t.p,{children:"...as the property type:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-typescript",children:"class UserProfileCriteria {\n  \n  public canRide?: FastRollerCoasterFilter; \n  \n  public attraction: string;\n} \n"})}),"\n",(0,i.jsxs)(t.p,{children:["...or declared in a ",(0,i.jsx)(t.code,{children:"filterWith"})," decorator"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-typescript",children:"class UserProfileCriteria {\n\n  public attraction: string;\n\n  @filterWith(FastRollerCoasterFilter)\n  public canRide?: boolean|; \n} \n"})}),"\n",(0,i.jsx)(t.p,{children:"A Custom filterDef will allow you to invoke unique query behaviors from a criteria property, without having to write a custom endpoint or repo."}),"\n",(0,i.jsx)(t.h2,{id:"how-to-implement",children:"How to Implement:"}),"\n",(0,i.jsx)(t.h3,{id:"step-1-create-your-own-filter-class",children:"Step 1: Create Your Own Filter Class"}),"\n",(0,i.jsx)(t.p,{children:"This is where you write general logic for the api platform."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-typescript",children:"class FastRollerCoasterFilter implements IFilter {\n  constructor() {\n  }\n  public property?: string;\n  public $not?: this;\n}\n"})}),"\n",(0,i.jsx)(t.h3,{id:"step-2-create-its-filterdefbuilder-class",children:"Step 2: Create its FilterDefBuilder Class"}),"\n",(0,i.jsxs)(t.p,{children:["This is where you add support for your particular database platform. You'll need to implement ",(0,i.jsx)(t.code,{children:"IFilterDefBuilder"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["The MongoDb Repo Plugin provdes a base class for you to extend: ",(0,i.jsx)(t.code,{children:"MongoFilterDefBuilder"}),"..."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-typescript",children:"class FastRollerCoasterFilterBuilder extends MongoFilterDefBuilder<FastRollerCoasterFilter> {\n\n}\n"})}),"\n",(0,i.jsx)(t.h3,{id:"step-3-register-it-with-the-repo",children:"Step 3: Register It with the Repo"}),"\n",(0,i.jsxs)(t.p,{children:["Declare your filter type from within your api's ",(0,i.jsx)(t.code,{children:"bootstrap()"})," method..."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-typescript",children:"this.registerFilterType(FastRollerCoasterFilter, FastRollerCoasterFilterBuilder);\n"})}),"\n",(0,i.jsx)(t.h3,{id:"step-4-use-custom-filter-as-a-property-type-on-a-criteria-class-for-your-entity",children:"Step 4: Use Custom Filter as a property type on a criteria class for your entity"}),"\n",(0,i.jsx)(t.p,{children:"There are two ways to use your custom filter type:"}),"\n",(0,i.jsx)(t.p,{children:"...as the property type:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-typescript",children:"class UserProfileCriteria {\n  \n  public canRide?: FastRollerCoasterFilter; \n  \n  public attraction: string;\n} \n"})}),"\n",(0,i.jsxs)(t.p,{children:["...or declared in a ",(0,i.jsx)(t.code,{children:"filterWith"})," decorator"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-typescript",children:"class UserProfileCriteria {\n\n  public attraction: string;\n\n  @filterWith(FastRollerCoasterFilter)\n  public canRide?: boolean|; \n} \n"})}),"\n",(0,i.jsx)(t.h3,{id:"step-5--custom-deserializers",children:"Step 5:  Custom Deserializers"}),"\n",(0,i.jsx)(t.p,{children:"Perhaps your custom filter type has a unique abbreviated string representation in a request that needs custom handling in order to translate it into a concrete instance off your filter."}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"StringFilter"})," does this, allowing an inbound request like"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-json",children:'{ "favoriteColor": "$sw_gr" }\n'})}),"\n",(0,i.jsxs)(t.p,{children:["...to be deserialized into the following instance of ",(0,i.jsx)(t.code,{children:"StringFilter"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-json",children:'{ \n  "property": "favoriteColor",\n  "$startsWith": "gr" \n}\n'})}),"\n",(0,i.jsx)(t.p,{children:"To apply a custom deserializer for your filter, you will need to register your deserializer with the api itself, so that it can use it when it encounters your filter during the inbound sequence of a request."}),"\n",(0,i.jsx)(t.h4,{id:"create-your-deserializer",children:"Create your Deserializer"}),"\n",(0,i.jsx)(t.p,{children:"So first, let's create a static method on the filter class for deserializing"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-typescript",children:"class FastRollerCoasterFilterSerializer {\n  public deserialize(value: string) {\n    let instance = new FastRollerCoasterFilter();\n    this.doSomethingUnique(value, instance); \n    return instance;\n  }\n}\n"})}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.em,{children:"(NOTE: YES, you can instantiate a serializer class, too, instead of using a static method.  We're just trying to keep it simple and stay focused on the registration in the following step.  That's the required part)"})}),"\n",(0,i.jsx)(t.h4,{id:"register-your-deserializer-with-the-api",children:"Register Your Deserializer With the Api"}),"\n",(0,i.jsxs)(t.p,{children:["In the ",(0,i.jsx)(t.code,{children:"bootstrap()"})," method of your api, tell the api itself how to deserialize an instance in a request:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-typescript",children:"Bootstrap(host: apiHost): void {\n  ...\n  api.registerFilterSerializerFor(FastRollerCoasterFilter, \n    x => new FastRollerCoasterFilterSerializer().deserialize(x)\n  );\n  ...\n}\n"})})]})}function p(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,t,r)=>{r.d(t,{R:()=>o,x:()=>l});var i=r(6540);const s={},n=i.createContext(s);function o(e){const t=i.useContext(n);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(n.Provider,{value:t},e.children)}}}]);